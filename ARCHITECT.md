# ğŸ§­ BOM-AI Platform Architecture Overview

### Phase 2 â€“ Application & Infrastructure Design

**Goal:**  
E-BOM â‡„ M-BOM æ§‹é€ ã‚’ä¸­æ ¸ã¨ã—ãŸè£½é€ æ¥­å‘ã‘ BOM ç®¡ç†åŸºç›¤ã‚’ã€AI è§£æã¨çµ±åˆã™ã‚‹æœ€å°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å®šç¾©ã™ã‚‹ã€‚  
è¨­è¨ˆï¼ˆEï¼‰â†’ è£½é€ ï¼ˆMï¼‰â†’ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆAIï¼‰ã‚’å¾ªç’°ã•ã›ã‚‹ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã€‚

---

## ğŸ—ï¸ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```

[Vercel / Next.js (FE)]
â”‚ Apollo Client (GraphQL)
â–¼
[ECS Fargate / NestJS (BE, Apollo Server)]
â”‚
â”œâ”€â”€ PostgreSQL (RDS, pgvector)
â”œâ”€â”€ S3 (å›³é¢ãƒ»ä»•æ§˜)
â”œâ”€â”€ SQS â†’ Lambda Worker (AI / ãƒ¡ã‚¿æŠ½å‡º / éåŒæœŸå‡¦ç†)
â””â”€â”€ OpenAI API / LangChain (AI è§£æ)

```

---

## âš™ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ä¸€è¦§

| å±¤                    | æŠ€è¡“                                                    | å½¹å‰²                                                  |
| --------------------- | ------------------------------------------------------- | ----------------------------------------------------- |
| **Frontend (FE)**     | Next.js (App Router) / TypeScript / MUI / Apollo Client | UI æ§‹ç¯‰ã€Cognito èªè¨¼ã€GraphQL é€šä¿¡                   |
| **Backend (BE)**      | NestJS / Apollo Server / Prisma                         | GraphQL APIãƒ»BOM/Item/Mapping ãƒ­ã‚¸ãƒƒã‚¯ãƒ»AI é€£æº       |
| **Database**          | PostgreSQL (RDS) + pgvector                             | BOMãƒ»Itemãƒ»Mapping ãªã©å…¨ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ãƒ»ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ |
| **Storage**           | S3                                                      | å›³é¢ãƒ»ä»•æ§˜ãƒ»é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«æ ¼ç´                          |
| **Message Queue**     | SQS                                                     | AI è§£æã‚„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿å‡¦ç†ãªã©ã®éåŒæœŸå®Ÿè¡Œ             |
| **Async Compute**     | Lambda                                                  | AI Worker, ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿æŠ½å‡º, å®šæœŸã‚¸ãƒ§ãƒ–ãªã©           |
| **Infra (Container)** | ECS (Fargate)                                           | NestJS ã®å¸¸é§ API ã‚³ãƒ³ãƒ†ãƒŠé‹ç”¨                        |
| **Auth**              | Cognito                                                 | JWT èªè¨¼ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°                    |
| **Deployment**        | Vercel (FE) / AWS ECS (BE) / GitHub Actions (CI/CD)     | ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³                                  |
| **Local Dev**         | Docker / LocalStack / Node.js                           | ãƒ­ãƒ¼ã‚«ãƒ«æ¤œè¨¼ç’°å¢ƒ                                      |

---

## ğŸ§© ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆè©³ç´°

### 1. Frontend

- **Next.js (App Router æ§‹æˆ)**
  - CSR/ISR ä¸¡å¯¾å¿œ
  - Material UI ã§è¨­è¨ˆè€…ãƒ»è£½é€ è€…å‘ã‘ã®æ“ä½œ UI æ§‹ç¯‰
  - GraphQL é€šä¿¡ï¼ˆApollo Clientï¼‰ã§ BOM/Item/AI çµæœã‚’å–å¾—
- **Auth**: Cognito é€£æºï¼ˆlocal ã§ã¯é–‹ç™ºç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ aws ã‹ã‚‰ä½¿ç”¨ï¼‰
- **ä¸»ãªç”»é¢**
  - BOM ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆéšå±¤æ§‹é€ ï¼‹å·®åˆ†è¡¨ç¤ºï¼‰
  - Item ãƒªã‚¹ãƒˆãƒ»è©³ç´°
  - Eâ‡„M å¯¾å¿œãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼
  - AI è§£æçµæœãƒ‘ãƒãƒ«ï¼ˆè¦ç´„ï¼ææ¡ˆï¼‰

---

### 2. Backend (NestJS on Fargate)

- **NestJS æ§‹é€ **

```

src/
â”œâ”€â”€ main.ts
â”œâ”€â”€ app.module.ts
â”œâ”€â”€ modules/
â”‚ â”œâ”€â”€ auth/
â”‚ â”œâ”€â”€ item/
â”‚ â”œâ”€â”€ bom/
â”‚ â”œâ”€â”€ mapping/
â”‚ â”œâ”€â”€ files/
â”‚ â”œâ”€â”€ ai/
â”‚ â””â”€â”€ queue/
â””â”€â”€ prisma/

```

- **GraphQL (Apollo Server)**
- è‡ªå‹•ã‚¹ã‚­ãƒ¼ãƒç”Ÿæˆ (`@nestjs/graphql`)
- Resolver å˜ä½ã§ Module åˆ†å‰²
- Subscriptions å¯¾å¿œï¼ˆAI å‡¦ç†çµæœã® Push é€šçŸ¥ï¼‰

- **Service ãƒ¬ã‚¤ãƒ¤**
- `bom.service.ts`: E-BOM/M-BOM CRUDãƒ»éšå±¤æ“ä½œ
- `mapping.service.ts`: BomMap ç”Ÿæˆãƒ»å·®åˆ†è¨ˆç®—
- `ai.service.ts`: OpenAI åŸ‹ã‚è¾¼ã¿ï¼è¦ç´„å‡¦ç†
- `queue.service.ts`: SQS é€£æºï¼ˆenqueue/dequeueï¼‰

- **Prisma**
- DB ã‚¹ã‚­ãƒ¼ãƒã¯ 3NF ã§æ­£è¦åŒ–æ¸ˆã¿ï¼ˆä¸Šè¨˜ãƒ¢ãƒ‡ãƒ«ï¼‰
- pgvector æ‹¡å¼µã‚’æœ‰åŠ¹åŒ–
- `vector`ã‚«ãƒ©ãƒ ã§ AI åŸ‹ã‚è¾¼ã¿ä¿å­˜ï¼†é¡ä¼¼æ¤œç´¢

- **AI é€£æº**
- OpenAI Embedding API (`text-embedding-3-large`)
- LangChain ã§ RAGãƒ»é¡ä¼¼æ¤œç´¢ã‚’æŠ½è±¡åŒ–
- çµæœã‚’ `AIInsight` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜

---

### 3. éåŒæœŸå‡¦ç†ï¼ˆLambda + SQSï¼‰

| å‡¦ç†              | ãƒˆãƒªã‚¬ãƒ¼                      | æ¦‚è¦                                             |
| ----------------- | ----------------------------- | ------------------------------------------------ |
| **AI è§£æã‚¸ãƒ§ãƒ–** | SQSï¼ˆ`startAIAnalyze`å®Ÿè¡Œæ™‚ï¼‰ | BOM æ§‹é€ ã‚’è§£æã—ã€åŸ‹ã‚è¾¼ã¿ç”Ÿæˆãƒ»è¦ç´„ã‚’å®Ÿæ–½       |
| **S3 ãƒ¡ã‚¿æŠ½å‡º**   | S3 PutObject ã‚¤ãƒ™ãƒ³ãƒˆ         | ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•è§£æï¼ˆCAD/Excel ãƒ¡ã‚¿ï¼‰ |
| **å¤œé–“ãƒãƒƒãƒ**    | CloudWatch Event              | ãƒ™ã‚¯ãƒˆãƒ«å†ç”Ÿæˆã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†æ§‹ç¯‰ãªã©           |
| **é€šçŸ¥ Webhook**  | æ‰‹å‹• / Queue                  | ä»–ã‚·ã‚¹ãƒ†ãƒ ã¸ã®é€£æºé€šçŸ¥                           |

**å‡¦ç†ãƒ•ãƒ­ãƒ¼ä¾‹ï¼š**

1. NestJS â†’ `SQS.sendMessage({ job: "analyze", bomId })`
2. Lambda Worker ãŒ SQS ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
3. DB ã‹ã‚‰ BOM æ§‹é€ ã‚’å–å¾—ã—ã€OpenAI API ã«é€ä¿¡
4. çµæœï¼ˆembedding, summaryï¼‰ã‚’ä¿å­˜
5. NestJS Subscription çµŒç”±ã§ FE ã¸é€šçŸ¥

---

### 4. Database (PostgreSQL + pgvector)

- ãƒ¢ãƒ‡ãƒ«æ§‹æˆã¯æç¤ºã®é€šã‚Š
- `Tenant/User`ï¼šãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåŸºç›¤
- `Item/Bom/BomItem/BomLink`ï¼šæ§‹æˆç®¡ç†ã®ä¸­æ ¸
- `BomMap`ï¼šEâ‡„M å¯¾å¿œãƒãƒƒãƒ”ãƒ³ã‚°
- `Folder/File`ï¼šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆéšå±¤æ§‹é€ 
- `quantity`ã¯ `BomLink` ã«ã®ã¿ä¿æŒï¼ˆæ­£è¦åŒ– â—ï¼‰
- `attributes` / `metadata` ã¯ JSONB
- ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼š`ivfflat`ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã¯ Cascade è¨­å®š

---

### 5. Storage (S3)

| ãƒã‚±ãƒƒãƒˆ       | ç”¨é€”              | å‚™è€ƒ                       |
| -------------- | ----------------- | -------------------------- |
| `bom-files`    | å›³é¢ãƒ»ä»•æ§˜ãƒ»ç”»åƒ  | Presigned URL ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |
| `bom-metadata` | è§£ææ¸ˆã¿ãƒ¡ã‚¿ JSON | Lambda ãŒè‡ªå‹•ç”Ÿæˆ          |

- **Presigned URL ç™ºè¡Œ API**
- NestJS â†’ S3 SDK â†’ ä¸€æ™‚ URL ç”Ÿæˆ
- FE ã‹ã‚‰ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

- **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿æŠ½å‡º Lambda**
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã§èµ·å‹•
- EXIFï¼CAD å±æ€§ï¼æ‹¡å¼µå­åˆ†é¡ã‚’ DB ç™»éŒ²

---

### 6. èªè¨¼ãƒ»èªå¯

| å±¤      | æ©Ÿèƒ½                                      |
| ------- | ----------------------------------------- |
| Cognito | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ      |
| NestJS  | JWT æ¤œè¨¼ï¼ˆPassport-JWTï¼‰ï¼Tenant å¢ƒç•Œåˆ¶å¾¡ |
| FE      | AccessToken ã‚’ Apollo Header ã«ä»˜ä¸       |
| DB      | `tenantId`ã§ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ—åˆ†é›¢            |

---

### 7. é–‹ç™ºãƒ»é‹ç”¨ç’°å¢ƒ

#### ğŸ”¹ ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ

```

docker-compose.yml
â”œâ”€â”€ postgres
â”œâ”€â”€ nest (API)
â”œâ”€â”€ next (FE)
â””â”€â”€ localstack (S3, SQS)

```

- NestJS / Next.js ã¯ Node å®Ÿè¡Œ
- Prisma ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†
- LocalStack ã§ S3/SQS ã® mock
- `.env` ã«ç’°å¢ƒå¤‰æ•°ç®¡ç†

#### ğŸ”¹ CI/CD

- GitHub Actions
  - Prisma migrate â†’ Test â†’ Build â†’ Deploy
- Fargate ã‚¿ã‚¹ã‚¯å®šç¾©æ›´æ–°
- Lambda ã¯ CDK Stack ã¨ã—ã¦åˆ¥ç®¡ç†

---

### 8. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ / ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- VPC å†…é€šä¿¡ (Fargate, RDS, Lambda)
- Security Group:
  - Fargate â‡„ RDS : 5432/TCP
  - Fargate â‡„ S3/SQS : IAM ãƒ­ãƒ¼ãƒ«è¨±å¯
- SecretsManager ã§ API Key / DB æ¥ç¶šç®¡ç†
- WAF + HTTPS(ALB) + CloudFront(Optional)

---

---

## ğŸ§  å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```

              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚        Vercel / FE          â”‚
              â”‚  Next.js + Apollo Client    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ GraphQL
                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚      ECS Fargate / NestJS       â”‚
            â”‚  Apollo Server / Prisma / AI    â”‚
            â”‚  Auth: Cognito + Passport-JWT   â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚                â”‚
      PostgreSQL(pgvector)   â”‚
            â”‚                â”‚  async job
            â–¼                â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚    RDS       â”‚     â”‚  SQS Queue   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                           â”‚  Lambda    â”‚
                           â”‚ (AI Worker)â”‚
                           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                           â”‚   S3       â”‚
                           â”‚ Files/Meta â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

---

## âœ… ã¾ã¨ã‚

| å±¤         | æŠ€è¡“                                    | å½¹å‰²                       |
| ---------- | --------------------------------------- | -------------------------- |
| FE         | Next.js / Apollo / MUI                  | UIãƒ»GraphQL é€šä¿¡           |
| BE         | NestJS / Apollo / Prisma                | APIãƒ»æ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯ãƒ»AI é€£æº |
| éåŒæœŸ     | SQS + Lambda                            | AI ã‚¸ãƒ§ãƒ–ãƒ»ãƒ¡ã‚¿è§£æãƒ»é€šçŸ¥  |
| DB         | Postgres + pgvector                     | ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ»ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | S3                                      | å›³é¢ãƒ»ä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«         |
| ã‚¤ãƒ³ãƒ•ãƒ©   | ECS(Fargate) / Cognito / SecretsManager | é‹ç”¨ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£         |
| é–‹ç™ºç’°å¢ƒ   | Docker / LocalStack / Node              | ãƒ­ãƒ¼ã‚«ãƒ«çµ±åˆé–‹ç™º           |

---

### ğŸ“˜ Keywords

`NestJS`, `Apollo`, `Next.js`, `Prisma`, `PostgreSQL`, `pgvector`, `AWS ECS (Fargate)`,
`S3`, `SQS`, `Lambda`, `Cognito`, `OpenAI`, `LangChain`, `LocalStack`
